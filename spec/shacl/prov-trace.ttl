@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix acg: <https://agentcontextgraph.dev/ontology#> .
@prefix trace: <https://agentcontextgraph.dev/shacl/trace#> .

# =============================================================================
# PROV-O Trace Shapes
# Validates PROV activity traces produced by agent actions
# =============================================================================

# -----------------------------------------------------------------------------
# Main PROV Activity Trace Shape
# -----------------------------------------------------------------------------

trace:ProvTraceShape a sh:NodeShape ;
    sh:targetClass prov:Activity ;
    rdfs:label "PROV Activity Trace Shape"@en ;
    rdfs:comment "Validates PROV-O compliant activity traces from agent actions."@en ;

    sh:property [
        sh:path acg:id ;
        sh:name "id" ;
        sh:description "Unique identifier for this trace (URN format)" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^urn:uuid:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$" ;
        sh:message "Trace ID must be a valid UUID URN"
    ] ;

    sh:property [
        sh:path prov:startedAtTime ;
        sh:name "startedAtTime" ;
        sh:description "When the activity started" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime ;
        sh:message "startedAtTime is required and must be a valid ISO 8601 datetime"
    ] ;

    sh:property [
        sh:path prov:endedAtTime ;
        sh:name "endedAtTime" ;
        sh:description "When the activity ended" ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime
    ] ;

    sh:property [
        sh:path prov:wasAssociatedWith ;
        sh:name "wasAssociatedWith" ;
        sh:description "The agent that performed this activity" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:node trace:AgentAssociationShape ;
        sh:message "Trace must be associated with exactly one agent"
    ] ;

    sh:property [
        sh:path prov:used ;
        sh:name "used" ;
        sh:description "The context and affordance used in this activity" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:node trace:UsedContextShape ;
        sh:message "Trace must reference the used context and affordance"
    ] ;

    sh:property [
        sh:path prov:generated ;
        sh:name "generated" ;
        sh:description "The outcome generated by this activity" ;
        sh:maxCount 1 ;
        sh:node trace:GeneratedOutcomeShape
    ] ;

    sh:property [
        sh:path prov:wasInformedBy ;
        sh:name "wasInformedBy" ;
        sh:description "Previous traces that informed this activity" ;
        sh:datatype xsd:string
    ] ;

    sh:property [
        sh:path acg:causalLabel ;
        sh:name "causalLabel" ;
        sh:description "do() label for causal interventions" ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^do\\(.+\\)$" ;
        sh:message "Causal label must use do() notation"
    ] .

# -----------------------------------------------------------------------------
# Agent Association Shape
# -----------------------------------------------------------------------------

trace:AgentAssociationShape a sh:NodeShape ;
    rdfs:label "Agent Association Shape"@en ;

    sh:property [
        sh:path acg:agentDID ;
        sh:name "agentDID" ;
        sh:description "DID of the agent" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^did:[a-z0-9]+:.+$" ;
        sh:message "Must be a valid DID"
    ] ;

    sh:property [
        sh:path acg:agentType ;
        sh:name "agentType" ;
        sh:description "Abstract Agent Type of the agent" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^aat:.+AgentType$" ;
        sh:message "Must reference a valid AAT"
    ] .

# -----------------------------------------------------------------------------
# Used Context Shape
# -----------------------------------------------------------------------------

trace:UsedContextShape a sh:NodeShape ;
    rdfs:label "Used Context Shape"@en ;

    sh:property [
        sh:path acg:contextId ;
        sh:name "contextId" ;
        sh:description "ID of the context graph used" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^urn:uuid:" ;
        sh:message "Context ID must be a URN"
    ] ;

    sh:property [
        sh:path acg:affordance ;
        sh:name "affordance" ;
        sh:description "The affordance that was traversed" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:node trace:AffordanceRefShape
    ] .

# -----------------------------------------------------------------------------
# Affordance Reference Shape
# -----------------------------------------------------------------------------

trace:AffordanceRefShape a sh:NodeShape ;
    rdfs:label "Affordance Reference Shape"@en ;

    sh:property [
        sh:path acg:id ;
        sh:name "id" ;
        sh:description "Affordance ID" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string
    ] ;

    sh:property [
        sh:path acg:actionType ;
        sh:name "actionType" ;
        sh:description "Type of action performed" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:minLength 1
    ] .

# -----------------------------------------------------------------------------
# Generated Outcome Shape
# -----------------------------------------------------------------------------

trace:GeneratedOutcomeShape a sh:NodeShape ;
    rdfs:label "Generated Outcome Shape"@en ;

    sh:property [
        sh:path acg:outcome ;
        sh:name "outcome" ;
        sh:description "Result status of the action" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:in ( "success" "failure" "partial" "pending" "cancelled" ) ;
        sh:message "Outcome must be one of: success, failure, partial, pending, cancelled"
    ] ;

    sh:property [
        sh:path acg:error ;
        sh:name "error" ;
        sh:description "Error message if outcome is failure" ;
        sh:maxCount 1 ;
        sh:datatype xsd:string
    ] ;

    sh:property [
        sh:path acg:outputRef ;
        sh:name "outputRef" ;
        sh:description "Reference to any generated output" ;
        sh:maxCount 1 ;
        sh:datatype xsd:string
    ] ;

    sh:property [
        sh:path acg:effects ;
        sh:name "effects" ;
        sh:description "Side effects produced by this action" ;
        sh:datatype xsd:string
    ] .

# =============================================================================
# Verifiable Credential Shapes
# =============================================================================

# -----------------------------------------------------------------------------
# Verifiable Credential Shape
# -----------------------------------------------------------------------------

trace:VerifiableCredentialShape a sh:NodeShape ;
    sh:targetClass acg:VerifiableCredential ;
    rdfs:label "Verifiable Credential Shape"@en ;
    rdfs:comment "Validates W3C Verifiable Credentials."@en ;

    sh:property [
        sh:path acg:id ;
        sh:name "id" ;
        sh:description "Credential identifier" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string
    ] ;

    sh:property [
        sh:path rdf:type ;
        sh:name "type" ;
        sh:description "Credential types" ;
        sh:minCount 1 ;
        sh:qualifiedValueShape [
            sh:hasValue "VerifiableCredential"
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:message "Credential must include 'VerifiableCredential' type"
    ] ;

    sh:property [
        sh:path acg:issuer ;
        sh:name "issuer" ;
        sh:description "DID of the credential issuer" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^did:[a-z0-9]+:.+$" ;
        sh:message "Issuer must be a valid DID"
    ] ;

    sh:property [
        sh:path acg:issuanceDate ;
        sh:name "issuanceDate" ;
        sh:description "When the credential was issued" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime
    ] ;

    sh:property [
        sh:path acg:expirationDate ;
        sh:name "expirationDate" ;
        sh:description "When the credential expires" ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime
    ] ;

    sh:property [
        sh:path acg:credentialSubject ;
        sh:name "credentialSubject" ;
        sh:description "Subject of the credential" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:node trace:CredentialSubjectShape
    ] .

# -----------------------------------------------------------------------------
# Credential Subject Shape
# -----------------------------------------------------------------------------

trace:CredentialSubjectShape a sh:NodeShape ;
    rdfs:label "Credential Subject Shape"@en ;

    sh:property [
        sh:path acg:id ;
        sh:name "id" ;
        sh:description "DID of the credential holder" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^did:[a-z0-9]+:.+$"
    ] .

# -----------------------------------------------------------------------------
# Agent Capability Credential Shape
# -----------------------------------------------------------------------------

trace:AgentCapabilityCredentialShape a sh:NodeShape ;
    sh:targetClass acg:AgentCapabilityCredential ;
    rdfs:label "Agent Capability Credential Shape"@en ;
    rdfs:comment "Validates credentials that grant agent capabilities."@en ;

    sh:property [
        sh:path acg:credentialSubject ;
        sh:node [
            sh:property [
                sh:path acg:capability ;
                sh:name "capability" ;
                sh:description "Capability being granted" ;
                sh:minCount 1 ;
                sh:datatype xsd:string
            ] ;
            sh:property [
                sh:path acg:agentType ;
                sh:name "agentType" ;
                sh:description "Agent type this capability applies to" ;
                sh:maxCount 1 ;
                sh:datatype xsd:string ;
                sh:pattern "^aat:.+AgentType$"
            ] ;
            sh:property [
                sh:path acg:scope ;
                sh:name "scope" ;
                sh:description "Scope restrictions on the capability" ;
                sh:datatype xsd:string
            ]
        ]
    ] .

# =============================================================================
# Trust Relationship Shape
# =============================================================================

trace:TrustRelationshipShape a sh:NodeShape ;
    sh:targetClass acg:TrustRelationship ;
    rdfs:label "Trust Relationship Shape"@en ;
    rdfs:comment "Validates trust relationships between brokers."@en ;

    sh:property [
        sh:path acg:id ;
        sh:name "id" ;
        sh:description "Trust relationship identifier" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string
    ] ;

    sh:property [
        sh:path acg:partnerBrokerDID ;
        sh:name "partnerBrokerDID" ;
        sh:description "DID of the partner broker" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^did:[a-z0-9]+:.+$"
    ] ;

    sh:property [
        sh:path acg:trustLevel ;
        sh:name "trustLevel" ;
        sh:description "Level of trust granted" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:in ( "FullTrust" "LimitedTrust" "VerifyAlways" )
    ] ;

    sh:property [
        sh:path acg:status ;
        sh:name "status" ;
        sh:description "Current status of the trust relationship" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:in ( "pending" "active" "revoked" "expired" )
    ] ;

    sh:property [
        sh:path acg:establishedAt ;
        sh:name "establishedAt" ;
        sh:description "When trust was established" ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime
    ] ;

    sh:property [
        sh:path acg:expiresAt ;
        sh:name "expiresAt" ;
        sh:description "When the trust relationship expires" ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime
    ] ;

    sh:property [
        sh:path acg:revokedAt ;
        sh:name "revokedAt" ;
        sh:description "When trust was revoked (if applicable)" ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime
    ] .

# =============================================================================
# Workflow Shape
# =============================================================================

trace:WorkflowShape a sh:NodeShape ;
    sh:targetClass acg:Workflow ;
    rdfs:label "Workflow Shape"@en ;
    rdfs:comment "Validates workflow state objects."@en ;

    sh:property [
        sh:path acg:id ;
        sh:name "id" ;
        sh:description "Workflow identifier" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string
    ] ;

    sh:property [
        sh:path acg:goal ;
        sh:name "goal" ;
        sh:description "Goal the workflow aims to achieve" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:minLength 1
    ] ;

    sh:property [
        sh:path acg:status ;
        sh:name "status" ;
        sh:description "Current workflow status" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:in ( "planning" "executing" "observing" "completed" "failed" "cancelled" )
    ] ;

    sh:property [
        sh:path acg:startedAt ;
        sh:name "startedAt" ;
        sh:description "When the workflow started" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime
    ] ;

    sh:property [
        sh:path acg:completedAt ;
        sh:name "completedAt" ;
        sh:description "When the workflow completed" ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime
    ] .

# =============================================================================
# Task Shape
# =============================================================================

trace:TaskShape a sh:NodeShape ;
    sh:targetClass acg:Task ;
    rdfs:label "Task Shape"@en ;
    rdfs:comment "Validates task objects within workflows."@en ;

    sh:property [
        sh:path acg:id ;
        sh:name "id" ;
        sh:description "Task identifier" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string
    ] ;

    sh:property [
        sh:path acg:workflowId ;
        sh:name "workflowId" ;
        sh:description "ID of the parent workflow" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string
    ] ;

    sh:property [
        sh:path acg:taskType ;
        sh:name "type" ;
        sh:description "Type of task" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:in ( "plan" "approve" "execute" "observe" "archive" "review" "test" "deploy" )
    ] ;

    sh:property [
        sh:path acg:status ;
        sh:name "status" ;
        sh:description "Current task status" ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:in ( "pending" "assigned" "running" "completed" "failed" "blocked" )
    ] ;

    sh:property [
        sh:path acg:agentDID ;
        sh:name "agentDID" ;
        sh:description "DID of assigned agent" ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^did:[a-z0-9]+:.+$"
    ] .
